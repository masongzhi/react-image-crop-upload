import e,{Component as t}from"react";import a from"prop-types";var r={jpg:"image/jpeg",png:"image/png",gif:"image/gif",svg:"image/svg+xml",psd:"image/photoshop"};var i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},c=function(a){function c(t){i(this,c);var a=s(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,t));a.changeFile=function(e){e.preventDefault();var t=e.target.files||e.dataTransfer.files;a.setState({file:t[0]}),a.setSourceImg(t[0]),a.setStep(2)},a.setSourceImg=function(e){var t=new FileReader;t.onload=function(e){a.setState({sourceImgUrl:t.result}),a.startCrop()},t.readAsDataURL(e)},a.startCrop=function(){var e=a,t=e.props,r=t.width,i=t.height,n=e.state,s=n.ratio,c=n.scale,l=n.sourceImgUrl,u=a.sourceImgMasking,h=new Image;h.src=l,h.onload=function(){var t=h.naturalWidth,n=h.naturalHeight,l=t/n,g=u.width,m=u.height,p=0,d=0;if(t<r||n<i)return e.hasError=!0,e.errorMsg="图片最低像素为（宽*高）："+r+"*"+i,!1;s>l&&(m=g/l,d=(u.height-m)/2),s<l&&(g=m*l,p=(u.width-g)/2),a.setState({scale:o({},c,{range:0,x:p,y:d,width:g,height:m,minWidth:g,minHeight:m,maxWidth:t*u.scale,maxHeight:n*u.scale,naturalWidth:t,naturalHeight:n}),sourceImg:h}),a.createImg()}},a.prepareUpload=function(){var e=a.state.createImgUrl,t=function(e){var t=e.split(","),a=t[1];a=window.atob(a);for(var r=t[0].match(/:(.*?);/)[1],i=new Uint8Array(a.length),n=0;n<a.length;n++)i[n]=a.charCodeAt(n);return new Blob([i],{type:r})}(e);a.props.upload({createImgUrl:e,blob:t,file:a.state.file})},a.preventDefault=function(e){return e.preventDefault(),!1},a.imgStartMove=function(e){if(e.preventDefault(),a.state.isSupportTouch&&!e.targetTouches)return!1;var t=e.targetTouches?e.targetTouches[0]:e,r=a.state,i=r.sourceImgMouseDown,n=r.scale,o=i;o.mX=t.screenX,o.mY=t.screenY,o.x=n.x,o.y=n.y,o.on=!0},a.imgMove=function(e){if(e.preventDefault(),a.state.isSupportTouch&&!e.targetTouches)return!1;var t=e.targetTouches?e.targetTouches[0]:e,r=a.state,i=r.sourceImgMouseDown,n=i.on,s=i.mX,c=i.mY,l=i.x,u=i.y,h=r.scale,g=a.sourceImgMasking,m=l+(t.screenX-s),p=u+(t.screenY-c);n&&(m>0&&(m=0),p>0&&(p=0),m<g.width-h.width&&(m=g.width-h.width),p<g.height-h.height&&(p=g.height-h.height),a.setState({scale:o({},a.state.scale,{x:m,y:p})}))},a.createImg=function(e){var t=a,r=t.state,i=r.mime,n=r.sourceImg,s=r.scale,c=s.x,l=s.y,u=s.width,h=s.height,g=t.props,m=g.imgFormat,p=g.imgBgc,d=a.sourceImgMasking.scale,f=a.canvasRef.current,v=f.getContext("2d");e&&t.setState({sourceImgMouseDown:o({},t.state.sourceImgMouseDown,{on:!1})}),f.width=t.props.width,f.height=t.props.height,v.clearRect(0,0,t.props.width,t.props.height),v.fillStyle="png"===m?"rgba(0,0,0,0)":p,v.fillRect(0,0,t.props.width,t.props.height),v.drawImage(n,c/d,l/d,u/d,h/d),t.setState({createImgUrl:f.toDataURL(i)})},a.handleClick=function(e){e.target!==a.fileinput.current&&(e.preventDefault(),a.fileinput.current.click())},a.ripple=function(e){!function(e,t){var a=Object.assign({ele:e.target,type:"hit",bgc:"rgba(0, 0, 0, 0.15)"},t),r=a.ele;if(r){var i=r.getBoundingClientRect(),n=r.querySelector(".e-ripple");switch(n?n.className="e-ripple":((n=document.createElement("span")).className="e-ripple",n.style.height=n.style.width=Math.max(i.width,i.height)+"px",r.appendChild(n)),a.type){case"center":n.style.top=i.height/2-n.offsetHeight/2+"px",n.style.left=i.width/2-n.offsetWidth/2+"px";break;default:n.style.top=e.pageY-i.top-n.offsetHeight/2-document.body.scrollTop+"px",n.style.left=e.pageX-i.left-n.offsetWidth/2-document.body.scrollLeft+"px"}n.style.backgroundColor=a.bgc,n.className="e-ripple z-active"}}(e)},a.setStep=function(e){1===e&&(a.fileinput.current.value=null),a.setState({step:e})},a.startZoomSub=function(e){var t=a,r=t.state.scale;a.setState({scale:o({},r,{zoomSubOn:!0})}),function e(){if(r.zoomSubOn){var a=r.range<=0?0:--r.range;t.zoomImg(a),setTimeout(function(){e()},60)}}()},a.zoomImg=function(e){var t=a,r=a.state.scale,i=a.sourceImgMasking,n=r.maxWidth,s=r.maxHeight,c=r.minWidth,l=r.minHeight,u=r.width,h=r.height,g=r.x,m=r.y,p=i,d=p.width,f=p.height,v=c+(n-c)*e/100,y=l+(s-l)*e/100,w=d/2-v/u*(d/2-g),b=f/2-y/h*(f/2-m);w>0&&(w=0),b>0&&(b=0),w<d-v&&(w=d-v),b<f-y&&(b=f-y),a.setState({scale:o({},r,{x:w,y:b,width:v,height:y,range:e})}),setTimeout(function(){r.range===e&&t.createImg()},300)},a.endZoomSub=function(e){var t=a.state.scale;a.setState({scale:o({},t,{zoomSubOn:!1})})},a.startZoomAdd=function(e){var t=a,r=t.state.scale;a.setState({scale:o({},r,{zoomAddOn:!0})}),function e(){if(r.zoomAddOn){var a=r.range>=100?100:++r.range;t.zoomImg(a),setTimeout(function(){e()},60)}}()},a.endZoomAdd=function(e){var t=a.state.scale;a.setState({scale:o({},t,{zoomAddOn:!1})})},a.zoomChange=function(e){a.zoomImg(e.target.value)},a.rotateImg=function(e){var t=a.state,i=t.sourceImg,n=t.scale,o=n.naturalWidth,s=n.naturalHeight,c=s,l=o,u=a.canvasRef.current,h=u.getContext("2d");u.width=c,u.height=l,h.clearRect(0,0,c,l),h.fillStyle="rgba(0,0,0,0)",h.fillRect(0,0,c,l),h.translate(c,0),h.rotate(90*Math.PI/180),h.drawImage(i,0,0,o,s);var g=u.toDataURL(r.png);a.setState({sourceImgUrl:g}),a.startCrop()},a.showFiles=function(){var t=a.state,r=t.sourceImgUrl,i=t.createImgUrl,n=t.file,s=t.scale,c=a.props,l=c.noRotate,u=c.noCircle,h=c.noSquare;return n?e.createElement("div",{className:"ricu-step2"},e.createElement("div",null,e.createElement("div",{className:"ricu-step2-left"},e.createElement("img",{style:a.sourceImgStyle,src:r,draggable:!1,onDrag:a.preventDefault,onDragStart:a.preventDefault,onDragEnd:a.preventDefault,onDragLeave:a.preventDefault,onDragOver:a.preventDefault,onDragEnter:a.preventDefault,onDrop:a.preventDefault,onTouchStart:a.imgStartMove,onTouchMove:a.imgMove,onTouchEnd:a.createImg,onTouchCancel:a.createImg,onMouseDown:a.imgStartMove,onMouseMove:a.imgMove,onMouseUp:a.createImg,onMouseOut:a.createImg,alt:""}),e.createElement("div",{className:"ricu-img-shade ricu-img-shade-1",style:a.sourceImgShadeStyle}),e.createElement("div",{className:"ricu-img-shade ricu-img-shade-2",style:a.sourceImgShadeStyle})),e.createElement("div",{className:"ricu-range"},e.createElement("input",{type:"range",value:s.range,step:"1",min:"0",max:"100",onMouseMove:a.zoomChange,onChange:a.zoomChange}),e.createElement("i",{onMouseDown:a.startZoomSub,onMouseOut:a.endZoomSub,onMouseUp:a.endZoomSub,className:"ricu-icon5"}),e.createElement("i",{onMouseDown:a.startZoomAdd,onMouseOut:a.endZoomAdd,onMouseUp:a.endZoomAdd,className:"ricu-icon6"})),!l&&e.createElement("div",{className:"ricu-rotate"},e.createElement("i",{onClick:a.rotateImg},"↻"))),e.createElement("div",{className:"ricu-step2-right"},!h&&e.createElement("div",null,e.createElement("img",{src:i,style:a.previewStyle,alt:""}),e.createElement("div",{className:"ricu-step2-right-text"},"头像预览")),!u&&e.createElement("div",null,e.createElement("img",{src:i,style:o({},a.previewStyle,{borderRadius:"100%"}),alt:""}),e.createElement("div",{className:"ricu-step2-right-text"},"头像预览")))):""},a.canvasRef=e.createRef(),a.fileinput=e.createRef();var n=-1===["jpg","png"].indexOf(a.props.imgFormat)?"jpg":a.props.imgFormat,l=r[n];return a.state={step:1,file:null,isSupported:"function"==typeof FormData,isSupportTouch:document.hasOwnProperty("ontouchstart"),sourceImgMouseDown:{on:!1,mime:l,mX:0,mY:0,x:0,y:0},scale:{zoomAddOn:!1,zoomSubOn:!1,range:1,x:0,y:0,width:0,height:0,maxWidth:0,maxHeight:0,minWidth:0,minHeight:0,naturalWidth:0,naturalHeight:0},sourceImgContainer:{width:240,height:184},mime:r.jpg,ratio:a.props.width/a.props.height,sourceImg:null,sourceImgUrl:"",createImgUrl:"",previewContainer:{width:100,height:100}},a}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(c,t),n(c,[{key:"render",value:function(){var t=this,a=this.props,r=a.width,i=a.height,n=a.off,o=this.state,s=o.step,c=o.isSupported;return e.createElement("div",{className:"ricu"},e.createElement("div",{className:"ricu-wrap"},e.createElement("div",{className:"ricu-close",onClick:n},e.createElement("i",{className:"ricu-icon4"})),e.createElement("div",{className:"ricu-step1",style:{display:1!==s&&"none"}},e.createElement("div",{className:"ricu-drop-area",onDragLeave:this.preventDefault,onDragOver:this.preventDefault,onDragEnter:this.preventDefault,onClick:this.handleClick,onDrop:this.changeFile},e.createElement("i",{className:"ricu-icon1"},e.createElement("i",{className:"ricu-icon1-arrow"}),e.createElement("i",{className:"ricu-icon1-body"}),e.createElement("i",{className:"ricu-icon1-bottom"})),e.createElement("span",{className:"ricu-hint"},"点击，或拖动图片至此处"),e.createElement("span",{className:"ricu-no-supported-hint",style:{display:c&&"none"}},"浏览器不支持该功能，请使用IE10以上或其他现代浏览器！"),e.createElement("input",{style:{display:"none"},id:"file",type:"file",accept:"image/png, image/jpeg, image/gif, image/jpg",onChange:this.changeFile,ref:this.fileinput}))),e.createElement("div",{style:{display:2!==s&&"none"}},this.showFiles()),e.createElement("div",{className:"ricu-operate"},e.createElement("button",{onClick:function(){return t.setStep.call(t,1)},onMouseDown:this.ripple,style:{display:1===s&&"none"}},"上一步"),e.createElement("button",{style:{display:1===s&&"none"},className:"ricu-operate-btn",onClick:this.prepareUpload,onMouseDown:this.ripple},"保存"),e.createElement("button",{onClick:n,onMouseDown:this.ripple,style:{display:1!==s&&"none"}},"关闭")),e.createElement("canvas",{style:{display:"none"},width:r,height:i,ref:this.canvasRef})))}},{key:"sourceImgMasking",get:function(){var e=this.state,t=e.sourceImgContainer,a=e.ratio,r=this.props,i=r.width,n=r.height,o=t,s=o.width/o.height,c=0,l=0,u=o.width,h=o.height,g=1;return a<s&&(g=o.height/n,u=o.height*a,c=(o.width-u)/2),a>s&&(g=o.width/i,h=o.width/a,l=(o.height-h)/2),{scale:g,x:c,y:l,width:u,height:h}}},{key:"sourceImgStyle",get:function(){var e=this.state.scale,t=this.sourceImgMasking;return{position:"absolute",top:e.y+t.y+"px",left:e.x+t.x+"px",width:e.width+"px",height:e.height+"px"}}},{key:"sourceImgShadeStyle",get:function(){var e=this.state.sourceImgContainer,t=this.sourceImgMasking;return{width:(t.width===e.width?t.width:(e.width-t.width)/2)+"px",height:(t.height===e.height?t.height:(e.height-t.height)/2)+"px"}}},{key:"previewStyle",get:function(){var e=this.state,t=e.ratio,a=e.previewContainer,r=a.width,i=a.height,n=r/i;return t<n&&(r=a.height*t),t>n&&(i=a.width/t),{width:r+"px",height:i+"px"}}}]),c}();c.defaultProps={imgFormat:"png",imgBgc:"#fff",width:200,height:200,noRotate:!0,noCircle:!1,noSquare:!1},c.propTypes={width:a.number,height:a.number,imgFormat:a.string,imgBgc:a.string,noCircle:a.bool,noSquare:a.bool,noRotate:a.bool,off:a.func.isRequired,upload:a.func.isRequired};export default c;
