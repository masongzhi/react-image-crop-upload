import e,{Component as t}from"react";import r from"prop-types";var a={jpg:"image/jpeg",png:"image/png",gif:"image/gif",svg:"image/svg+xml",psd:"image/photoshop"};function n(e){var t=e.split(","),r=t[1];r=window.atob(r);for(var a=t[0].match(/:(.*?);/)[1],n=new Uint8Array(r.length),o=0;o<r.length;o++)n[o]=r.charCodeAt(o);return new Blob([n],{type:a})}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},l=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},u=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},h=function(r){function o(t){i(this,o);var r=u(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,t));r.changeFile=function(e){e.preventDefault();var t=e.target.files||e.dataTransfer.files;r.setState({file:t[0]}),r.setSourceImg(t[0]),r.setStep(2)},r.setSourceImg=function(e){var t=new FileReader;t.onload=function(e){r.setState({sourceImgUrl:t.result}),r.startCrop()},t.readAsDataURL(e)},r.startCrop=function(){var e=r,t=e.props,a=t.width,n=t.height,o=e.state,i=o.ratio,s=o.scale,l=o.sourceImgUrl,u=r.sourceImgMasking,h=new Image;h.src=l,h.onload=function(){var t=h.naturalWidth,o=h.naturalHeight,l=t/o,p=u.width,g=u.height,m=0,d=0;if(t<a||o<n)return e.hasError=!0,e.errorMsg="图片最低像素为（宽*高）："+a+"*"+n,!1;i>l&&(g=p/l,d=(u.height-g)/2),i<l&&(p=g*l,m=(u.width-p)/2),r.setState({scale:c({},s,{range:0,x:m,y:d,width:p,height:g,minWidth:p,minHeight:g,maxWidth:t*u.scale,maxHeight:o*u.scale,naturalWidth:t,naturalHeight:o}),sourceImg:h}),r.createImg()}},r.prepareUpload=function(){var e=r.state.createImgUrl,t=n(e);r.props.upload({createImgUrl:e,blob:t,file:r.state.file})},r.preventDefault=function(e){return e.preventDefault(),!1},r.imgStartMove=function(e){if(e.preventDefault(),r.state.isSupportTouch&&!e.targetTouches)return!1;var t=e.targetTouches?e.targetTouches[0]:e,a=r.state,n=a.sourceImgMouseDown,o=a.scale,i=n;i.mX=t.screenX,i.mY=t.screenY,i.x=o.x,i.y=o.y,i.on=!0},r.imgMove=function(e){if(e.preventDefault(),r.state.isSupportTouch&&!e.targetTouches)return!1;var t=e.targetTouches?e.targetTouches[0]:e,a=r.state,n=a.sourceImgMouseDown,o=n.on,i=n.mX,s=n.mY,l=n.x,u=n.y,h=a.scale,p=r.sourceImgMasking,g=l+(t.screenX-i),m=u+(t.screenY-s);o&&(g>0&&(g=0),m>0&&(m=0),g<p.width-h.width&&(g=p.width-h.width),m<p.height-h.height&&(m=p.height-h.height),r.setState({scale:c({},r.state.scale,{x:g,y:m})}))},r.createImg=function(e){var t=r,a=t.state,n=a.mime,o=a.sourceImg,i=a.scale,s=i.x,l=i.y,u=i.width,h=i.height,p=t.props,g=p.imgFormat,m=p.imgBgc,d=r.sourceImgMasking.scale,f=r.canvasRef.current,v=f.getContext("2d");e&&t.setState({sourceImgMouseDown:c({},t.state.sourceImgMouseDown,{on:!1})}),f.width=t.props.width,f.height=t.props.height,v.clearRect(0,0,t.props.width,t.props.height),v.fillStyle="png"===g?"rgba(0,0,0,0)":m,v.fillRect(0,0,t.props.width,t.props.height),v.drawImage(o,s/d,l/d,u/d,h/d),t.setState({createImgUrl:f.toDataURL(n)})},r.handleClick=function(e){e.target!==r.fileinput.current&&(e.preventDefault(),r.fileinput.current.click())},r.ripple=function(e){!function(e,t){var r=Object.assign({ele:e.target,type:"hit",bgc:"rgba(0, 0, 0, 0.15)"},t),a=r.ele;if(a){var n=a.getBoundingClientRect(),o=a.querySelector(".e-ripple");switch(o?o.className="e-ripple":((o=document.createElement("span")).className="e-ripple",o.style.height=o.style.width=Math.max(n.width,n.height)+"px",a.appendChild(o)),r.type){case"center":o.style.top=n.height/2-o.offsetHeight/2+"px",o.style.left=n.width/2-o.offsetWidth/2+"px";break;default:o.style.top=e.pageY-n.top-o.offsetHeight/2-document.body.scrollTop+"px",o.style.left=e.pageX-n.left-o.offsetWidth/2-document.body.scrollLeft+"px"}o.style.backgroundColor=r.bgc,o.className="e-ripple z-active"}}(e)},r.setStep=function(e){1===e&&(r.fileinput.current.value=null),r.setState({step:e})},r.startZoomSub=function(e){var t=r,a=t.state.scale;r.setState({scale:c({},a,{zoomSubOn:!0})}),function e(){if(a.zoomSubOn){var r=a.range<=0?0:--a.range;t.zoomImg(r),setTimeout(function(){e()},60)}}()},r.zoomImg=function(e){var t=r,a=r.state.scale,n=r.sourceImgMasking,o=a.maxWidth,i=a.maxHeight,s=a.minWidth,l=a.minHeight,u=a.width,h=a.height,p=a.x,g=a.y,m=n,d=m.width,f=m.height,v=s+(o-s)*e/100,y=l+(i-l)*e/100,w=d/2-v/u*(d/2-p),b=f/2-y/h*(f/2-g);w>0&&(w=0),b>0&&(b=0),w<d-v&&(w=d-v),b<f-y&&(b=f-y),r.setState({scale:c({},a,{x:w,y:b,width:v,height:y,range:e})}),setTimeout(function(){a.range===e&&t.createImg()},300)},r.endZoomSub=function(e){var t=r.state.scale;r.setState({scale:c({},t,{zoomSubOn:!1})})},r.startZoomAdd=function(e){var t=r,a=t.state.scale;r.setState({scale:c({},a,{zoomAddOn:!0})}),function e(){if(a.zoomAddOn){var r=a.range>=100?100:++a.range;t.zoomImg(r),setTimeout(function(){e()},60)}}()},r.endZoomAdd=function(e){var t=r.state.scale;r.setState({scale:c({},t,{zoomAddOn:!1})})},r.zoomChange=function(e){r.zoomImg(e.target.value)},r.rotateImg=function(e){var t=r.state,n=t.sourceImg,o=t.scale,i=o.naturalWidth,s=o.naturalHeight,c=s,l=i,u=r.canvasRef.current,h=u.getContext("2d");u.width=c,u.height=l,h.clearRect(0,0,c,l),h.fillStyle="rgba(0,0,0,0)",h.fillRect(0,0,c,l),h.translate(c,0),h.rotate(90*Math.PI/180),h.drawImage(n,0,0,i,s);var p=u.toDataURL(a.png);r.setState({sourceImgUrl:p}),r.startCrop()},r.showFiles=function(){var t=r.state,a=t.sourceImgUrl,n=t.createImgUrl,o=t.file,i=t.scale,s=r.props,l=s.noRotate,u=s.noCircle,h=s.noSquare;return o?e.createElement("div",{className:"ricu-step2"},e.createElement("div",null,e.createElement("div",{className:"ricu-step2-left"},e.createElement("img",{style:r.sourceImgStyle,src:a,draggable:!1,onDrag:r.preventDefault,onDragStart:r.preventDefault,onDragEnd:r.preventDefault,onDragLeave:r.preventDefault,onDragOver:r.preventDefault,onDragEnter:r.preventDefault,onDrop:r.preventDefault,onTouchStart:r.imgStartMove,onTouchMove:r.imgMove,onTouchEnd:r.createImg,onTouchCancel:r.createImg,onMouseDown:r.imgStartMove,onMouseMove:r.imgMove,onMouseUp:r.createImg,onMouseOut:r.createImg,alt:""}),e.createElement("div",{className:"ricu-img-shade ricu-img-shade-1",style:r.sourceImgShadeStyle}),e.createElement("div",{className:"ricu-img-shade ricu-img-shade-2",style:r.sourceImgShadeStyle})),e.createElement("div",{className:"ricu-range"},e.createElement("input",{type:"range",value:i.range,step:"1",min:"0",max:"100",onMouseMove:r.zoomChange,onChange:r.zoomChange}),e.createElement("i",{onMouseDown:r.startZoomSub,onMouseOut:r.endZoomSub,onMouseUp:r.endZoomSub,className:"ricu-icon5"}),e.createElement("i",{onMouseDown:r.startZoomAdd,onMouseOut:r.endZoomAdd,onMouseUp:r.endZoomAdd,className:"ricu-icon6"})),!l&&e.createElement("div",{className:"ricu-rotate"},e.createElement("i",{onClick:r.rotateImg},"↻"))),e.createElement("div",{className:"ricu-step2-right"},!h&&e.createElement("div",null,e.createElement("img",{src:n,style:r.previewStyle,alt:""}),e.createElement("div",{className:"ricu-step2-right-text"},"头像预览")),!u&&e.createElement("div",null,e.createElement("img",{src:n,style:c({},r.previewStyle,{borderRadius:"100%"}),alt:""}),e.createElement("div",{className:"ricu-step2-right-text"},"头像预览")))):""},r.canvasRef=e.createRef(),r.fileinput=e.createRef();var s=-1===["jpg","png"].indexOf(r.props.imgFormat)?"jpg":r.props.imgFormat,l=a[s];return r.state={step:1,file:null,isSupported:"function"==typeof FormData,isSupportTouch:document.hasOwnProperty("ontouchstart"),sourceImgMouseDown:{on:!1,mime:l,mX:0,mY:0,x:0,y:0},scale:{zoomAddOn:!1,zoomSubOn:!1,range:1,x:0,y:0,width:0,height:0,maxWidth:0,maxHeight:0,minWidth:0,minHeight:0,naturalWidth:0,naturalHeight:0},sourceImgContainer:{width:240,height:184},mime:a.jpg,ratio:r.props.width/r.props.height,sourceImg:null,sourceImgUrl:"",createImgUrl:"",previewContainer:{width:100,height:100}},r}return l(o,t),s(o,[{key:"render",value:function(){var t=this,r=this.props,a=r.width,n=r.height,o=r.off,i=this.state,s=i.step,c=i.isSupported;return e.createElement("div",{className:"ricu"},e.createElement("div",{className:"ricu-wrap"},e.createElement("div",{className:"ricu-close",onClick:o},e.createElement("i",{className:"ricu-icon4"})),e.createElement("div",{className:"ricu-step1",style:{display:1!==s&&"none"}},e.createElement("div",{className:"ricu-drop-area",onDragLeave:this.preventDefault,onDragOver:this.preventDefault,onDragEnter:this.preventDefault,onClick:this.handleClick,onDrop:this.changeFile},e.createElement("i",{className:"ricu-icon1"},e.createElement("i",{className:"ricu-icon1-arrow"}),e.createElement("i",{className:"ricu-icon1-body"}),e.createElement("i",{className:"ricu-icon1-bottom"})),e.createElement("span",{className:"ricu-hint"},"点击，或拖动图片至此处"),e.createElement("span",{className:"ricu-no-supported-hint",style:{display:c&&"none"}},"浏览器不支持该功能，请使用IE10以上或其他现代浏览器！"),e.createElement("input",{style:{display:"none"},id:"file",type:"file",accept:"image/png, image/jpeg, image/gif, image/jpg",onChange:this.changeFile,ref:this.fileinput}))),e.createElement("div",{style:{display:2!==s&&"none"}},this.showFiles()),e.createElement("div",{className:"ricu-operate"},e.createElement("button",{onClick:function(){return t.setStep.call(t,1)},onMouseDown:this.ripple,style:{display:1===s&&"none"}},"上一步"),e.createElement("button",{style:{display:1===s&&"none"},className:"ricu-operate-btn",onClick:this.prepareUpload,onMouseDown:this.ripple},"保存"),e.createElement("button",{onClick:o,onMouseDown:this.ripple,style:{display:1!==s&&"none"}},"关闭")),e.createElement("canvas",{style:{display:"none"},width:a,height:n,ref:this.canvasRef})))}},{key:"sourceImgMasking",get:function(){var e=this.state,t=e.sourceImgContainer,r=e.ratio,a=this.props,n=a.width,o=a.height,i=t,s=i.width/i.height,c=0,l=0,u=i.width,h=i.height,p=1;return r<s&&(p=i.height/o,u=i.height*r,c=(i.width-u)/2),r>s&&(p=i.width/n,h=i.width/r,l=(i.height-h)/2),{scale:p,x:c,y:l,width:u,height:h}}},{key:"sourceImgStyle",get:function(){var e=this.state.scale,t=this.sourceImgMasking;return{position:"absolute",top:e.y+t.y+"px",left:e.x+t.x+"px",width:e.width+"px",height:e.height+"px"}}},{key:"sourceImgShadeStyle",get:function(){var e=this.state.sourceImgContainer,t=this.sourceImgMasking;return{width:(t.width===e.width?t.width:(e.width-t.width)/2)+"px",height:(t.height===e.height?t.height:(e.height-t.height)/2)+"px"}}},{key:"previewStyle",get:function(){var e=this.state,t=e.ratio,r=e.previewContainer,a=r.width,n=r.height,o=a/n;return t<o&&(a=r.height*t),t>o&&(n=r.width/t),{width:a+"px",height:n+"px"}}}]),o}();h.defaultProps={imgFormat:"png",imgBgc:"#fff",width:200,height:200,noRotate:!0,noCircle:!1,noSquare:!1},h.propTypes={width:r.number,height:r.number,imgFormat:r.string,imgBgc:r.string,noCircle:r.bool,noSquare:r.bool,noRotate:r.bool,off:r.func.isRequired,upload:r.func.isRequired};var p=function(r){function a(t){i(this,a);var r=u(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,t));return r.upload=function(e){var t=e.createImgUrl,a=(e.blob,e.file,r.cropRef.current),i=r.props,s=i.url,c=i.params,l=i.headers,u=i.field,h=i.withCredentials,p=i.method,g=i.handleCropUploadSuccess,m=i.handleCropUploadFail,d=i.ki,f=a.state.imgFormat,v=new FormData;v.append(u,n(t),u+"."+f),"object"===(void 0===c?"undefined":o(c))&&c&&Object.keys(c).forEach(function(e){v.append(e,c[e])}),new Promise(function(e,t){var r=new XMLHttpRequest;r.open(p,s,!0),r.withCredentials=h,r.onreadystatechange=function(){4===this.readyState&&(200===this.status||201===this.status?e(JSON.parse(this.responseText)):t(this.status))},"object"===(void 0===l?"undefined":o(l))&&l&&Object.keys(l).forEach(function(e){r.setRequestHeader(e,l[e])}),r.send(v)}).then(function(e){g(e,u,d)},function(e){m(e,u,d)})},r.cropRef=e.createRef(),r}return l(a,t),s(a,[{key:"render",value:function(){return e.createElement(h,c({},this.props,{upload:this.upload,ref:this.cropRef}))}}]),a}();p.defaultProps={url:"",method:"POST",field:"upload",params:null,headers:null,withCredentials:!1,ki:0},p.propTypes={url:r.string,method:r.string,field:r.string,params:r.object,headers:r.object,withCredentials:r.bool,ki:r.number,handleCropUploadSuccess:r.func.isRequired,handleCropUploadFail:r.func.isRequired};export default p;
